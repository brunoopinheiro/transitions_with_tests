# Mocks e Patches
<div class="c-kWDhvw"><article class="c-daJEgu"><h1>
Usando o m√≥dulo <code class="inline">unittest</code> para criar <em>mocks</em> em testes</h1>
<p>
O m√≥dulo <code class="inline">unittest</code> √© uma biblioteca de testes unit√°rios nativa do Python. Ele √© inspirado no JUnit, um <em>framework</em> de testes para Java. O <code class="inline">unittest</code> √© uma ferramenta muito poderosa, mas tamb√©m √© um pouco mais complexa que o <em>Pytest</em>. Por isso, vamos aprender a utiliz√°-la aos poucos.</p>
<p>
A grande vantagem de utilizar o <code class="inline">unittest</code> √© que ele j√° vem instalado com o Python, ent√£o n√£o √© necess√°rio instalar nenhuma biblioteca adicional. Al√©m disso, ele √© uma ferramenta muito completa, que nos permite criar <em>mocks</em> de forma poderosa e organizada.</p>
<p>
E melhor: o <em>Pytest</em> se integra muito bem com o <code class="inline">unittest</code>, ent√£o √© poss√≠vel utilizar os dois juntos! ü§©</p>
<p>
Para executar os c√≥digos de exemplo, utilize o <em>Pytest</em>. Para isso, crie o ambiente virtual (<code class="inline">python3 -m venv .venv</code>), garanta que ele esteja ativo (<code class="inline">source .venv/bin/activate</code>) e instale o <em>Pytest</em> com o comando <code class="inline">pip install pytest==7.3.1</code>.</p>
<h2>
Criando um <em>mock</em> com o <code class="inline">unittest</code></h2>
<p>
Para criar um <em>mock</em> com o <code class="inline">unittest</code>, √© preciso utilizar a classe <code class="inline">unittest.mock.Mock</code>.
Essa classe √© muito parecida com a fixture <code class="inline">monkeypatch</code> do Pytest, mas um pouco mais complexa.</p>
<p>
Vamos a um exemplo com leitura de arquivos JSON!
Primeiro, vamos criar um arquivo <code class="inline">person_data.json</code> com o seguinte conte√∫do:</p>
</article><div class="c-jykYDu"><div class="c-fkerDR"><button type="button" class="c-gfRGUc">Copiar</button><pre style="color: rgb(248, 248, 242); background: rgb(39, 40, 34); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: auto; border-radius: 0.3em;"><code class="language-json" style="color: rgb(248, 248, 242); background: none; text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">1</span><span class="token" style="color: rgb(248, 248, 242);">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">2</span><span>    </span><span class="token" style="color: rgb(249, 38, 114);">"nome"</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">"Jo√£o"</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">3</span><span>    </span><span class="token" style="color: rgb(249, 38, 114);">"idade"</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span> </span><span class="token" style="color: rgb(174, 129, 255);">30</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">4</span><span></span><span class="token" style="color: rgb(248, 248, 242);">}</span></code></pre></div></div><article class="c-daJEgu">
<p>
Para esse exemplo de manipula√ß√£o de arquivos JSON, criaremos tr√™s arquivos:</p>
<ol>
  <li>
<code class="inline">analyzer.py</code>, que vai conter as fun√ß√µes que vamos testar;  </li>
  <li>
<code class="inline">tests/test_analyzer.py</code>, que vai conter os testes;  </li>
  <li>
<code class="inline">tests/__init__.py</code>, que ficar√° vazio mesmo. Seu prop√≥sito √© indicar ao Python que a pasta <code class="inline">tests</code> √© um pacote Python.  </li>
</ol>
</article><div class="c-jykYDu"><div class="c-fkerDR"><button type="button" class="c-gfRGUc">Copiar</button><pre style="color: rgb(248, 248, 242); background: rgb(39, 40, 34); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: auto; border-radius: 0.3em;"><code class="language-python" style="color: rgb(248, 248, 242); background: none; text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">1</span><span class="token" style="color: rgb(130, 146, 162);"># arquivo: analyzer.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">2</span><span></span><span class="token" style="color: rgb(102, 217, 239);">import</span><span> json
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">5</span><span></span><span class="token" style="color: rgb(102, 217, 239);">def</span><span> </span><span class="token" style="color: rgb(230, 219, 116);">read_json_file</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>file_path</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">6</span><span>    </span><span class="token" style="color: rgb(102, 217, 239);">with</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">open</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>file_path</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">"r"</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span> </span><span class="token" style="color: rgb(102, 217, 239);">as</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">file</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">7</span><span>        </span><span class="token" style="color: rgb(102, 217, 239);">return</span><span> json</span><span class="token" style="color: rgb(248, 248, 242);">.</span><span>load</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span class="token" style="color: rgb(166, 226, 46);">file</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">9</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">10</span><span></span><span class="token" style="color: rgb(102, 217, 239);">def</span><span> </span><span class="token" style="color: rgb(230, 219, 116);">analyze_json_file</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>file_path</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span> </span><span class="token" style="color: rgb(248, 248, 242);">-</span><span class="token" style="color: rgb(248, 248, 242);">&gt;</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">str</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">11</span><span>    </span><span class="token" style="color: rgb(102, 217, 239);">if</span><span> </span><span class="token" style="color: rgb(102, 217, 239);">not</span><span> file_path</span><span class="token" style="color: rgb(248, 248, 242);">.</span><span>endswith</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span class="token" style="color: rgb(166, 226, 46);">".json"</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">12</span><span>        </span><span class="token" style="color: rgb(102, 217, 239);">raise</span><span> ValueError</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span class="token" style="color: rgb(166, 226, 46);">"O arquivo precisa ser um arquivo JSON."</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">14</span><span>    data </span><span class="token" style="color: rgb(248, 248, 242);">=</span><span> read_json_file</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>file_path</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">15</span><span>    </span><span class="token" style="color: rgb(102, 217, 239);">return</span><span> </span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">16</span><span>        </span><span class="token string-interpolation" style="color: rgb(166, 226, 46);">f"A pessoa de nome </span><span class="token string-interpolation interpolation" style="color: rgb(248, 248, 242);">{</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation" style="color: rgb(248, 248, 242);">[</span><span class="token string-interpolation interpolation" style="color: rgb(166, 226, 46);">'nome'</span><span class="token string-interpolation interpolation" style="color: rgb(248, 248, 242);">]</span><span class="token string-interpolation interpolation" style="color: rgb(248, 248, 242);">}</span><span class="token string-interpolation" style="color: rgb(166, 226, 46);"> "</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">17</span><span>        </span><span class="token string-interpolation" style="color: rgb(166, 226, 46);">f"tem </span><span class="token string-interpolation interpolation" style="color: rgb(248, 248, 242);">{</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation" style="color: rgb(248, 248, 242);">[</span><span class="token string-interpolation interpolation" style="color: rgb(166, 226, 46);">'idade'</span><span class="token string-interpolation interpolation" style="color: rgb(248, 248, 242);">]</span><span class="token string-interpolation interpolation" style="color: rgb(248, 248, 242);">}</span><span class="token string-interpolation" style="color: rgb(166, 226, 46);"> anos de idade."</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">18</span><span>    </span><span class="token" style="color: rgb(248, 248, 242);">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">19</span></code></pre></div></div><div class="c-jykYDu"><div class="c-fkerDR"><button type="button" class="c-gfRGUc">Copiar</button><pre style="color: rgb(248, 248, 242); background: rgb(39, 40, 34); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: auto; border-radius: 0.3em;"><code class="language-python" style="color: rgb(248, 248, 242); background: none; text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">1</span><span class="token" style="color: rgb(130, 146, 162);"># arquivo: tests/test_analyzer.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">2</span><span></span><span class="token" style="color: rgb(102, 217, 239);">from</span><span> analyzer </span><span class="token" style="color: rgb(102, 217, 239);">import</span><span> analyze_json_file
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">5</span><span></span><span class="token" style="color: rgb(102, 217, 239);">def</span><span> </span><span class="token" style="color: rgb(230, 219, 116);">test_analyze_json_file</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">6</span><span>    result </span><span class="token" style="color: rgb(248, 248, 242);">=</span><span> analyze_json_file</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span class="token" style="color: rgb(166, 226, 46);">"person_data.json"</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">7</span><span>    </span><span class="token" style="color: rgb(102, 217, 239);">assert</span><span> result </span><span class="token" style="color: rgb(248, 248, 242);">==</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">"A pessoa de nome Jo√£o tem 30 anos de idade."</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">8</span></code></pre></div></div><article class="c-daJEgu">
<blockquote>
  <p>
<strong>De olho na dica üëÄ:</strong> Quando um pacote √© importado em um m√≥dulo Python, o interpretador procura pelo arquivo <code class="inline">__init__.py</code> dentro do diret√≥rio correspondente ao pacote. A presen√ßa desse arquivo indica que o diret√≥rio √© um pacote v√°lido e pode ser importado.  </p>
</blockquote>
<p>
O teste que implementamos funciona, mas ele n√£o √© muito bom. Ele depende de um arquivo externo, e isso pode causar problemas. Por exemplo, se o arquivo <code class="inline">person_data.json</code> for apagado ou mesmo alterado, o teste vai falhar.</p>
<p>
Para resolver esse problema, criaremos um <em>mock</em> para a fun√ß√£o <code class="inline">read_json_file</code>, ou seja, um objeto que se comporta como a fun√ß√£o <code class="inline">read_json_file</code>. Para isso, ser√£o utilizadas a classe <code class="inline">unittest.mock.Mock</code> e a fun√ß√£o <code class="inline">patch</code>:</p>
</article><div class="c-jykYDu"><div class="c-fkerDR"><button type="button" class="c-gfRGUc">Copiar</button><pre style="color: rgb(248, 248, 242); background: rgb(39, 40, 34); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: auto; border-radius: 0.3em;"><code class="language-python" style="color: rgb(248, 248, 242); background: none; text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">1</span><span class="token" style="color: rgb(130, 146, 162);"># arquivo: testes/teste_analyzer.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">3</span><span></span><span class="token" style="color: rgb(130, 146, 162);"># Passo 1</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">4</span><span></span><span class="token" style="color: rgb(102, 217, 239);">from</span><span> unittest</span><span class="token" style="color: rgb(248, 248, 242);">.</span><span>mock </span><span class="token" style="color: rgb(102, 217, 239);">import</span><span> Mock</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span> patch
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">6</span><span></span><span class="token" style="color: rgb(102, 217, 239);">from</span><span> analyzer </span><span class="token" style="color: rgb(102, 217, 239);">import</span><span> analyze_json_file
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">7</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">9</span><span></span><span class="token" style="color: rgb(102, 217, 239);">def</span><span> </span><span class="token" style="color: rgb(230, 219, 116);">test_analyze_json_file</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">10</span><span>    </span><span class="token" style="color: rgb(130, 146, 162);"># Passo 2</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">11</span><span>    mock_read_json_file </span><span class="token" style="color: rgb(248, 248, 242);">=</span><span> Mock</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>return_value</span><span class="token" style="color: rgb(248, 248, 242);">=</span><span class="token" style="color: rgb(248, 248, 242);">{</span><span class="token" style="color: rgb(166, 226, 46);">"nome"</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">"Maria"</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">"idade"</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span> </span><span class="token" style="color: rgb(174, 129, 255);">31</span><span class="token" style="color: rgb(248, 248, 242);">}</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">12</span><span>    fake_file_path </span><span class="token" style="color: rgb(248, 248, 242);">=</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">"invalid.json"</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">14</span><span>    </span><span class="token" style="color: rgb(130, 146, 162);"># Passo 3</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">15</span><span>    </span><span class="token" style="color: rgb(102, 217, 239);">with</span><span> patch</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span class="token" style="color: rgb(166, 226, 46);">"analyzer.read_json_file"</span><span class="token" style="color: rgb(248, 248, 242);">,</span><span> mock_read_json_file</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span class="token" style="color: rgb(248, 248, 242);">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">16</span><span>        result </span><span class="token" style="color: rgb(248, 248, 242);">=</span><span> analyze_json_file</span><span class="token" style="color: rgb(248, 248, 242);">(</span><span>fake_file_path</span><span class="token" style="color: rgb(248, 248, 242);">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">17</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">18</span><span>    </span><span class="token" style="color: rgb(102, 217, 239);">assert</span><span> result </span><span class="token" style="color: rgb(248, 248, 242);">==</span><span> </span><span class="token" style="color: rgb(166, 226, 46);">"A pessoa de nome Maria tem 31 anos de idade."</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">19</span></code></pre></div></div><article class="c-daJEgu">
<p>
Vamos entender o que foi feito aqui:</p>
<ol>
  <li>
Primeiro, foram importadas a classe <code class="inline">Mock</code> e a fun√ß√£o <code class="inline">patch</code> do m√≥dulo <code class="inline">unittest.mock</code>.  </li>
  <li>
Depois, foi criado um <em>mock</em> para a fun√ß√£o <code class="inline">read_json_file</code> com a classe <code class="inline">Mock</code>.    <ul>
      <li>
Com o par√¢metro <code class="inline">return_value=</code>, foi definido que esse <em>mock</em> sempre retornar√° um dicion√°rio com os dados da pessoa.      </li>
    </ul>
  </li>
  <li>
Por fim, a fun√ß√£o <code class="inline">patch</code> foi utilizada para substituir a fun√ß√£o <code class="inline">read_json_file</code> dentro do m√≥dulo <code class="inline">analyzer</code> pelo <em>mock</em> criado.    <ul>
      <li>
Assim, quando a fun√ß√£o <code class="inline">analyze_json_file</code> for executada, ela utilizar√° o <em>mock</em> no lugar da fun√ß√£o <code class="inline">read_json_file</code>.      </li>
    </ul>
  </li>
</ol>
<p>
O resultado √© que o teste vai funcionar independentemente da exist√™ncia do arquivo, pois o <em>mock</em> criado sempre vai retornar o mesmo dicion√°rio. ü§©</p>
<blockquote>
  <p>
<strong>Anota a√≠ üìù:</strong> Podemos usar o patch como um decorador (<code class="inline">@patch(...)</code>) acima da assinatura da fun√ß√£o, ou como um <em>context manager</em> (<code class="inline">with patch(...):</code>) dentro da fun√ß√£o. Nesse exemplo utilizamos o <em>context manager</em>, e temos a vantagem de que o <em>patch</em> s√≥ est√° aplicado ‚Äòdentro‚Äô da identa√ß√£o do <code class="inline">with</code>.  </p>
</blockquote>
<h2>
Evoluindo nosso exemplo</h2>
<h3>
Averiguando se um <em>mock</em> foi chamado com os argumentos corretos</h3>
<p>
At√© o momento, n√£o h√° muita coisa diferente do que j√° havia sido feito com a fixture <code class="inline">monkeypatch</code>, do Pytest. Mas o <code class="inline">unittest</code> tem uma vantagem: ele nos permite averiguar se um <em>mock</em> foi chamado, o que √© muito √∫til para testar fun√ß√µes que chamam outras fun√ß√µes, por exemplo.</p>
<p>
Para averiguar se um <em>mock</em> foi chamado, utilizaremos o m√©todo <code class="inline">assert_called_with</code> do <em>mock</em>. Veja um exemplo:</p>
</article><div class="c-jykYDu"><div class="c-fkerDR"><button type="button" class="c-gfRGUc">Copiar</button><pre style="color: rgb(248, 248, 242); background: rgb(39, 40, 34); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: auto; border-radius: 0.3em;"><code class="language-diff" style="color: rgb(248, 248, 242); background: none; text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; font-size: 1em; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; overflow-wrap: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">1</span><span># arquivo: testes/teste_analyzer.py
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">2</span>from unittest.mock import Mock, patch
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">4</span>from analyzer import analyze_json_file
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">6</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">7</span>def test_analyze_json_file():
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">8</span><span></span><span class="token unchanged prefix"> </span><span class="token unchanged line">   mock_read_json_file = Mock(return_value={"nome": "Maria", "idade": 31})
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">9</span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">   fake_file_path = "invalid.json"
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">10</span><span class="token unchanged line"></span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">11</span><span></span><span class="token unchanged prefix"> </span><span class="token unchanged line">   with patch("analyzer.read_json_file", mock_read_json_file):
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">12</span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">       result = analyze_json_file(fake_file_path)
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">13</span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">   
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">14</span><span class="token unchanged line"></span><span class="token unchanged prefix"> </span><span class="token unchanged line">   assert result == "A pessoa de nome Maria tem 31 anos de idade."
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 1.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(130, 146, 162);">15</span><span class="token unchanged line"></span><span class="token inserted-sign prefix" style="color: rgb(166, 226, 46);">+</span><span class="token inserted-sign line" style="color: rgb(166, 226, 46);">   mock_read_json_file.assert_called_with(fake_file_path)</span></code></pre></div></div><article class="c-daJEgu">
<p>
Agora, se a fun√ß√£o <code class="inline">read_json_file</code> n√£o for chamada no decorrer da execu√ß√£o, o teste vai falhar!</p>
<blockquote>
  <p>
<strong>De olho na dica üëÄ:</strong> objetos Mock t√™m diversos m√©todos para averiguar se foram chamados. Voc√™ pode conferir a lista completa <a target="_blank" href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock">na documenta√ß√£o do m√≥dulo unittest</a>.  </p>
</blockquote>
<h3>
Explorando mais poderes do <code class="inline">unittest.mock</code></h3>
<p>
O <code class="inline">Mock</code> e o <code class="inline">patch</code> do <code class="inline">unittest.mock</code> s√£o ferramentas muito poderosas! Al√©m do que j√° foi mostrado, alguns outros exemplos do que elas possibilitam s√£o:</p>
<ul>
  <li>
Criar um <em>mock</em> com atributos e m√©todos (que podem ser <em>mocks</em> tamb√©m).  </li>
  <li>
Criar um <em>mock</em> que retorna um valor diferente a cada chamada.  </li>
  <li>
Criar um <em>mock</em> que lan√ßa uma exce√ß√£o.  </li>
</ul>
</article></div>